source: kubernetes:service_account
target: aws:eks_cluster
operational_rules:
  - if: |
      {{ $hasKey := false}}
      {{- if (hasField "Object.Metadata.Annotations" .Source) }}
        {{ range $key, $value := (fieldValue "Object.Metadata.Annotations" .Source) }}
          {{ if eq $key "eks.amazonaws.com/role-arn" }}
            {{ $hasKey = true }}
          {{ end }}
        {{ end }}
      {{- end }}
      {{ not $hasKey }}
    steps:
      - resource: '{{ .Source }}'
        direction: downstream
        resources:
          - aws:iam_role:{{ fieldValue "Object.Metadata.Name" .Source }}
        unique: true

  - if: '{{ not (hasUpstream "aws:iam_oidc_provider" .Target) }}'
    steps:
      - resource: '{{ .Target }}'
        direction: upstream
        resources:
          - aws:iam_oidc_provider:{{ .Target.Name }}
        unique: true

  - steps:
      - resource: '{{ downstream "aws:iam_role" .Source }}'
        direction: downstream
        resources:
          - '{{ upstream "aws:iam_oidc_provider" .Target }}'
