source: aws:service_discovery_http_namespace
target: aws:ecs_service
deployment_order_reversed: true

operational_rules:
  - configuration_rules:
      - resource: '{{ downstream "aws:ecs_task_definition" .Target }}'
        configuration:
          field: ContainerDefinitions[0].PortMappings
          value: | 
            [
              {{ $portMappings := (fieldValue "ContainerDefinitions[0].PortMappings" (fieldValue "TaskDefinition" .Target)) }}
              {{ range $i, $portMapping := $portMappings }}
              {
                "ContainerPort": {{ $portMapping.ContainerPort }},
                "HostPort": {{ $portMapping.HostPort }},
                "Protocol": "{{ $portMapping.Protocol }}",
                "AppProtocol": "http",
                "Name": "{{ $.Target.Name }}-port-{{ $i }}"
              }{{ if ne $i (sub (len $portMappings) 1) }},{{ end }}
              {{ end }}
            ]
      - resource: '{{ .Target }}'
        configuration:
          field: ServiceConnectConfiguration
          value: | 
            {
                "Enabled": true,
                "Services": [
                {{ $portMappings := (fieldValue "ContainerDefinitions[0].PortMappings" (fieldValue "TaskDefinition" .Target)) }}
                {{ range $i, $portMapping := $portMappings }}
                  {
                    "PortName": "{{ $.Target.Name }}-port-{{ $i }}",
                    "ClientAliases": [
                      {
                        "Port": {{ $portMapping.HostPort }},
                        "DnsName": "{{ $.Source.Name }}"
                      }
                    ]
                  }{{ if ne $i (sub (len $portMappings) 1) }},{{ end }}
                  {{ end }}
                ]
            }
            