source: aws:ecs_service
target: aws:efs_access_point
operational_rules:
  - configuration_rules:
      - resource: '{{ fieldValue "TaskDefinition" .Source }}'
        configuration:
          field: EfsVolumes
          value:
            FileSystem: '{{ fieldValue "FileSystem" .Target }}'
            AuthorizationConfig:
              AccessPoint: '{{ .Target}}'
              Iam: ENABLED
            TransitEncryption: ENABLED
  - if: |
      {{- if (hasDownstream "aws:vpc" .Source) }}
        {{- $ecsVpc := (downstream "aws:vpc" .Source) }}
        {{- $efsVpc := (downstream "aws:vpc" .Target) }}
        {{ ne $ecsVpc $efsVpc }}
      {{- else }}
        false
      {{- end }}
    steps:
      - resource: '{{ downstream "aws:vpc" .Source }}'
        direction: downstream
        resources:
          - '{{downstream "aws:vpc" .Target}}'
  - if: |
      {{ not (hasDownstream "aws:vpc" .Source) }}
    steps:
      - resource: '{{ .Source }}'
        direction: downstream
        resources:
          - '{{downstream "aws:vpc" .Target}}'
