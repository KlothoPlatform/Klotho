source: aws:cloudfront_distribution
target: aws:s3_bucket
operational_rules:
  - steps:
    - resource: '{{ .Source }}'
      direction: downstream
      resources:
        - aws:cloudfront_origin_access_identity
    configuration_rules:
      - resource: '{{ .Source }}'
        configuration: 
          field: Origins
          value:
            - S3OriginConfig:
                OriginAccessIdentity: |
                  {{ $oai := downstream "aws:cloudfront_origin_access_identity" .Source }}
                  {{ $oai }}#CloudfrontAccessIdentityPath
              DomainName: '{{ .Destination }}#BucketRegionalDomainName'
              OriginId: '{{ .Destination.Name }}'
      - resource: '{{ .Source }}'
        configuration: 
          field: DefaultCacheBehavior.TargetOriginId
          value: '{{ .Destination.Name }}'
  - if: '{{ hasField "IndexDocument" .Destination}}'
    configuration_rules:
      - resource: '{{ .Source }}'
        configuration: 
          field: DefaultRootObject
          value: '{{ fieldValue "IndexDocument" .Destination }}'
  - if: '{{ hasUpstream "aws:s3_bucket_policy" .Destination}}'
    steps:
    - resource: '{{ upstream "aws:s3_bucket_policy" .Destination}}'
      direction: downstream
      resources:
        - '{{ downstream "aws:cloudfront_origin_access_identity" .Source }}'
  - if: '{{ not (hasUpstream "aws:s3_bucket_policy" .Destination) }}'
    steps:
      - resource: '{{ .Destination }}'
        direction: upstream
        resources:
          - aws:s3_bucket_policy
      - resource: '{{ upstream "aws:s3_bucket_policy" .Destination}}'
        direction: downstream
        resources:
          - '{{ downstream "aws:cloudfront_origin_access_identity" .Source }}'